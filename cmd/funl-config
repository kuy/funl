#!/usr/bin/env bash

DESC=$(cat <<TEXT
Usage: funl config

Show available placeholders.
TEXT
)

if [[ 1 -eq $# ]] || [[ 3 -le $# ]]; then
  [[ -n $FUNL_DEBUG ]] && echo "funl-config: wrong arguments" >&2
  exit 1
fi

if [[ -z $FUNL_CONFIG ]]; then
  FUNL_CONFIG="$HOME/.funlrc"
fi

if [[ ! -e $FUNL_CONFIG ]]; then
  echo "funl: config not found" >&2
  exit 1
fi

if [[ 0 -eq $# ]]; then
  echo $(cat "$FUNL_CONFIG" | grep -o '[ ]*.*.src[ ]*:' | sed -e 's/.src[ ]*://' | sed 's/[ ]//g')
  exit 0
fi

# Find alias
alias=$(cat "$FUNL_CONFIG" | grep -E "[ ]*$1[ ]*:[ ]*&" | grep -oE '&[[:alnum:]_-]+' | sed 's/&//g' | head -n 1)
if [[ ! -z $alias ]]; then
  name="$alias"
else
  name="$1"
fi

line=$(cat "$FUNL_CONFIG" | grep -E "^$name\\.$2 *:" | head -n 1)
if [[ -z $line ]]; then
  case "$2" in
    # required
    src )
      echo "funl: '$name.$2' definition not found" >&2
      exit 1
      ;;
    # optional
    post )
      exit 0
      ;;
    # invalid type
    * )
      echo "funl: invalid type: '$2'" >&2
      exit 1
      ;;
  esac
fi

line=$(echo "$line" | sed -e "s/$name.$2 *: *//")

echo "$line"
